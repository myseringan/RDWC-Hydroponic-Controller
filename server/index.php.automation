
<?php elseif($page==='automation' && $isAdmin):
// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
if($_SERVER['REQUEST_METHOD']==='POST' && isset($_POST['add'])){
    $pdo->prepare("INSERT INTO automation (name, sensor, `condition`, value, pump_num, action) VALUES (?,?,?,?,?,?)")
        ->execute([$_POST['name'], $_POST['sensor'], $_POST['condition'], $_POST['value'], $_POST['pump_num'], $_POST['action']]);
    echo '<div class="alert alert-success">‚úì –ü—Ä–∞–≤–∏–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!</div>';
}
// –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
if(isset($_GET['delete'])){
    $pdo->prepare("DELETE FROM automation WHERE id = ?")->execute([intval($_GET['delete'])]);
    header('Location: ?page=automation');
    exit;
}
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
if(isset($_GET['toggle'])){
    $pdo->query("UPDATE automation SET enabled = NOT enabled WHERE id = " . intval($_GET['toggle']));
    header('Location: ?page=automation');
    exit;
}
$rules = $pdo->query("SELECT * FROM automation ORDER BY pump_num, id")->fetchAll(PDO::FETCH_ASSOC);
$sensors = ['air_temp' => '–¢ –≤–æ–∑–¥—É—Ö–∞', 'root_temp' => '–¢ –∫–æ—Ä–Ω–µ–π', 'air_hum' => '–í–ª–∞–∂–Ω–æ—Å—Ç—å', 'ph' => 'pH', 'ec' => 'EC', 'cpu_temp' => '–¢ CPU'];
$conditions = ['>' => '–±–æ–ª—å—à–µ', '<' => '–º–µ–Ω—å—à–µ', '>=' => '‚â•', '<=' => '‚â§', '=' => '—Ä–∞–≤–Ω–æ'];
?>
<div class="section">
<div class="section-title">ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –Ω–∞—Å–æ—Å–æ–≤</div>
<div class="alert alert-info">‚è± –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É. –î–æ–±–∞–≤—å—Ç–µ –≤ cron: <code>* * * * * php /var/www/wegabox/automation.php</code></div>

<h3 style="margin:20px 0 15px">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞</h3>
<?php if(empty($rules)):?>
<p style="color:#8b949e">–ü—Ä–∞–≤–∏–ª –Ω–µ—Ç</p>
<?php else:?>
<table>
<tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–£—Å–ª–æ–≤–∏–µ</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th><th></th></tr>
<?php foreach($rules as $r): ?>
<tr style="<?=$r['enabled']?'':'opacity:0.5'?>">
<td><?=htmlspecialchars($r['name'])?></td>
<td><?=$sensors[$r['sensor']]?> <?=$conditions[$r['condition']]?> <?=$r['value']?></td>
<td>–ù–∞—Å–æ—Å <?=$r['pump_num']?> ‚Üí <?=$r['action']==='on'?'üü¢ –í–ö–õ':'‚ö™ –í–´–ö–õ'?></td>
<td><a href="?page=automation&toggle=<?=$r['id']?>" style="color:<?=$r['enabled']?'#3fb950':'#f85149'?>"><?=$r['enabled']?'‚úì –ê–∫—Ç–∏–≤–Ω–æ':'‚úó –í—ã–∫–ª'?></a></td>
<td><a href="?page=automation&delete=<?=$r['id']?>" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å?')" style="color:#f85149">üóë</a></td>
</tr>
<?php endforeach;?>
</table>
<?php endif;?>

<h3 style="margin:30px 0 15px">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</h3>
<form method="POST" class="two-col">
<div>
<div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input name="name" required placeholder="–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ ON"></div>
<div class="form-group"><label>–î–∞—Ç—á–∏–∫</label><select name="sensor">
<?php foreach($sensors as $k=>$v):?><option value="<?=$k?>"><?=$v?></option><?php endforeach;?>
</select></div>
<div class="form-group"><label>–£—Å–ª–æ–≤–∏–µ</label><select name="condition">
<?php foreach($conditions as $k=>$v):?><option value="<?=$k?>"><?=$v?></option><?php endforeach;?>
</select></div>
</div>
<div>
<div class="form-group"><label>–ó–Ω–∞—á–µ–Ω–∏–µ</label><input name="value" type="number" step="0.1" required placeholder="23"></div>
<div class="form-group"><label>–ù–∞—Å–æ—Å</label><select name="pump_num">
<option value="1">–ù–∞—Å–æ—Å 1</option><option value="2">–ù–∞—Å–æ—Å 2</option>
<option value="3">–ù–∞—Å–æ—Å 3</option><option value="4">–ù–∞—Å–æ—Å 4</option>
</select></div>
<div class="form-group"><label>–î–µ–π—Å—Ç–≤–∏–µ</label><select name="action">
<option value="on">–í–∫–ª—é—á–∏—Ç—å</option><option value="off">–í—ã–∫–ª—é—á–∏—Ç—å</option>
</select></div>
</div>
</form>
<button type="submit" name="add" form="" onclick="this.form=this.previousElementSibling;this.form.submit()" class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
</div>
<?php endif;?>
